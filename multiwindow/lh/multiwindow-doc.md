多窗口开发补充文档：

本文档作为之前configuration 变化，多窗口系统分析文档的补充，来进一步介绍目前OPENTHOS8多窗口系统的开发情况，面临的问题以及接下来的计划。本文档共包括四部分，对于想要入门多窗口开发的工程师可以先去看之前完成的文档，多窗口部分代码繁多，内容复杂，在文档中对其进行详细的描述需要大量时间，在此我仍旧建议想要了解该部分内容的工程师直接翻看代码并与正在进行该部分内容开发的工程师进行沟通，来更快捷更有效地了解多窗口。

1.多窗口问题特征及定性经验

对于大多数工程师而言，尤其是测试工程师，多窗口相关的问题一直是使用系统所面临的最大阻碍之一，但通过一段时间的观察，包括从测试对问题的描述以及对任务的派给的情况来看，各位似乎对“定性一个问题属于多窗口问题”存在一些疏漏和困惑。本节内容的宗旨就是希望能够通过个人作为多窗口系统开发人员的经验和一些技巧来帮助大家今后更好地定性问题，也能够提高多窗口组解决问题的效率。前文所述，多窗口部分内容繁多，任谁也很难去对其中某类问题或某个现象做一个堪称完美的综述，本节内容归根结底只是我个人的经验，若与现实问题存在差异当然要以现实问题表现为准，若存在纰漏也欢迎各位积极指出，我一定认真改正。

在Android系统中，当由于某个问题导致系统崩溃时，能够通过logcat命令获取该崩溃对应的log信息，在该崩溃没有被不合理地catch 的情况下，这一方法总是能够生效的。通过Log信息定性问题属于哪一部分并不容易，但定性问题是否属于多窗口问题其实是很简单的。众所周知，多窗口系统主要包括AMS，WMS 以及APP三个子系统。在log信息中可以看到该错误的调用trace，凡是涉及上述子系统、且问题表征为窗口内容异常且显示未发生异常的，大概率是多窗口问题。没有包含该部分内容的，大多数不属于多窗口问题的范畴，这种情况建议进一步测试来定性具体问题种类。

但多窗口带来的问题，大多数情况下并不会引起崩溃，而是会引发显示上的错误，例如view错位等。这种时候可以通过adb中自带的monitor工具中的hiarchyviewer页面来查看应用的窗口结构，对于该结构出现问题的，可以定性为多窗口问题，对于结构没有出现问题的，同样也有可能是多窗口问题，但更建议去多多测试，先排除与显示方面相关的问题可能性，再定性为多窗口问题。

除此之外，在测试多窗口系统是否完善的过程中，对于同一应用要全面地从不同窗口状态以及不同状态间切换是否会对其产生影响来测试。窗口模式、全屏模式、窗口缩放、以及窗口和全屏模式间的转换等。尽可能地把能够想到的对窗口的操作在应用上逐个尝试，以保证测试全面性。

另外，对于少数应用，窗口问题发生的异常会被其自身catch，导致我们很难从log中判断该问题，而问题表征又没有明确的指向性，在这种情况下目前来说比较容易奏效的方法是在运行正常的系统（例如原生Android）上截取启动过程中所调用的activity，并对比分析。

最后，多窗口问题的表现较多，定性复杂，openthos8的多窗口修正又刚刚起步，更多地解决问题有助于更好地提升体验，希望各位能够积极将问题提出，来帮助openthos8的多窗口系统进一步完善。

2.与Statusbar Icon的交互方式

本节将针对之前文档中没有提到的多窗口与statusbar相关的前期工作进行一些介绍，内容不会很多，只涵盖多窗口部分的相关内容解决方案，不涵盖statusbar相关的内容

多窗口与statusbar交互的主要原因是打开应用时要将应用的图标对应地显示到statusbar上并在退出时随之消失，对于这一需求我们首先要获取应用打开的时点，退出的时点。应用打开的时点选择了方法ActivityManagerService中的setResumedActivityUncheckLocked方法，主要是基于该方法是应用启动过程中经过AMS的最后一个方法，能够执行到该方法说明该activity 启动成功切需要一个对应的图标，若在该位置之前执行则会导致一些启动失败的应用也出现图标，在该位置之后则会则会进入显示流程，执行主体转变为WMS，这不符合statusbar与AMS交互的逻辑，因此选择了这一位置，具体的调用链可以到代码中去看。应用退出的时点选择了ActivityStack中的removeActivityFromHistoryLocked方法，主要是因为该方法中有对正在退出的activity 是否为对应Task中的最后一个activity的判断，且任何activity的退出都会经过该方法，目前该位置的选择仍有一些疑问，具体表现为应用退出时图标消失会根据应用的不同存在一定延迟。

3.窗口结构问题分析

前文所述，在本文档之前已经有过两篇针对多窗口开发内容的文档，其主要描述对象为configuration变化问题和多窗口系统操作问题，这两方面问题都是当时正在解决的问题，因此形成了文档加以保存。目前对于openthos8来说个人进行解决的最关键问题就是窗口结构问题，因此在本节会对该问题进行分析。由于该问题目前尚未完全解决，因此分析内容相较前两篇文章会更简略。

窗口结构指的是应用窗口的层次结构。即从ViewRootImpl到DecorView到mContentView再到应用自身的view的树状结构。多窗口的很多问题都是由于窗口结构相较于单窗口发生变化而产生的。其中变化主要有两个方面，一个是内容变化，一个是操作变化。

内容变化指的就是用于进行多窗口操作的DecorCaptionView的出现对于整个窗口结构的影响，在openthos1中这一部分是通过multiwindouOutborder来实现的，由于大多数应用不知道该部分的存在，因此在运行过程中不会考虑到该部分，造成了很多应用对多窗口结构的破坏或自身无法正常地执行功能。在openthos8中，由于decorcaption是由谷歌实现的，这一问题相比openthos1中的实现大大减少，但对于一些常见应用仍然是致命的。目前对于本部分主要有两种修改策略，一种是通过干涉应用对窗口的操作，让应用在操作窗口时不要去破坏存在DecorCaption 的结构。另一种则是改变现有的窗口结构，将DecorCaptionView上移至窗口结构顶层，使其对应用来说变得不可见，从而避免应用对其进行修改。第一种方法的好处是不需要对窗口结构进行重新设计，弊端则是对于应用干涉方面功能的设计需要全面地分析各类应用对窗口操作的特点，提取共性综合考虑来使得干涉更高效，这个过程需要大量的分析和迭代，相对困难。相比之下，第二种方法若能够设计出合理的窗口结构则可以在大多数情况下保证应用不会对窗口结构进行破坏，但一个合理的新的窗口结构并不会简单地出现在你面前，况且由于当前的窗口结构出自谷歌官方之手，其内部稳定性能够有足够的保障，将其改变在适应第三方应用的同时更困难的可能是去适应Android原生对其的调用。

现实地考虑解决这一问题，个人认为可能还是需要上述两种方案的结合。充分分析现有改变窗口结构可行性的基础上设计一套新的窗口结构来避免大多数问题，通过研究解决存在于问题的第三方应用的问题来完善上述结构，最终达到一个稳定且适合openthos设计的多窗口结构实现。目前个人正在尝试将decorcaption移动到窗口层次的最上层来初步实现一个新的窗口结构，但由于稳定性暂时得不到太大保障并未提交到主代码中。目前通过微信、微博的问题对该结构进行了进一步完善，当该结构完善到符合系统稳定性要求时则会进行提交。同时对于通过该结构才能解决的问题也会尝试不改变窗口结构的方式进行解决，若其解决代价总是比改变窗口结构小的话，保持原有结构的方案则会更有效率。

第二点是操作变化，也就是原本不存在的缩放、全屏／窗口状态转换等内容对窗口的影响。这部分在configuration分析中又提及，在这里所说的缩放产生的结构变化更多的是对于资源文件加载等内容而言。目前这类问题尚未明显出现，但随着测试应用的增多很可能会出现。由于窗口化打开某应用时其大小不一定被覆盖在某个认为自己一定全屏运行的应用的资源文件范畴内，因此会出现加载不到资源文件导致的崩溃。这类问题很好定位，但很难修改。应用的资源文件是其自身决定的，即便是对某个应用使用非常规方法进行修改也效率很低，这方面内容的解决方案目前看上去很匮乏，因为应用自身没有适配的资源文件很难从外部进行干预。

另外就是对于一些应用而言，其并不会考虑到自身窗口大小会发生改变，因此其内容并不会随窗口大小改变而改变，这类问题在openthos1中比比皆是，逐个进行适配势必会影响系统的性能和代码的整洁，但对于这些并未进行适配的应用除去干涉外又不存在好的解决方案。这两类问题目前没有很好的解决途径，也没有太多的案例，随着案例的增多寻找其共性可能是一个相对值得期待的解决方法。



4.未来多窗口开发基本原则及简单规划

与自研应用等不同，多窗口没有明确的设计实现需求目标，对于多窗口系统的改进总要根据遇到的问题循序渐进，但仅仅是解决问题难免进入头痛医头脚痛医脚的局面，长此以往会使得代码冗余，性能受损。在openthos1中吃下了不少这样的亏之后，在openthos8初期希望能够对多窗口的开发和修改原则进行一个确认，并在此基础上根据目前已知的问题和系统情况对接下来一段时间的工作内容做一个规划，大家对这部分内容有什么想法和建议希望能够与我们交流。

多窗口系统是由AMS，WMS，APP三大部分，每一部分又包含众多组件，例如AMS中包含ActivityStack, ActivityStackSupervisor, ActivityManagerService等等。经过交流讨论，目前认为当遇到多窗口问题时尽可能地自底向上通过应用分析，组件分析到部分分析的方式来尽可能地将问题从结构上聚焦到某一组件上，从而令问题的解决更具备一般性，也尽可能少地去做字符串匹配来判断包名等内容，进而降低对性能的损耗。对于该方法虽然没有太多描述，但对于多窗口复杂的问题成因来说，想要将某一问题定性为某一组件的一般性问题并不容易，而且多窗口部分的主要任务是应用适配，我们无法保证应用是按照我们的想法编写的，总会有一些应用具备一些独一无二的特质使得我们的多窗口系统无法适配其运行，对于这类应用，在坚持上述原则基础上，若确定无法对其进行一般性提取，就不能够形式化地反对头痛医头的解决方法，解决问题始终是首要任务，理性地全面地分析过后，仍旧只有针对性解决这一条路可走的话就不得不这么做。但在针对性解决的实现过程中要尽量避免性能的损耗以及对尽量减少干涉的组件和步骤，尽可能少地影响针对情况外的系统运行。在时刻谨记上述原则的同时，多窗口的问题种类繁多，成因复杂，对于一个多窗口问题很有可能在分析过程中转化为其它问题（例如曾经存在过的微信小视频问题和ppt播放视频问题等），在分析过程中要时刻对这类情况保持警惕，多与可能相关的组进行交流，更准确地定位问题从而更高效地解决问题。

对于接下来的开发规划，首先是对目前已知的多窗口问题进行分析，对主次，成因进行分析并对解决难度进行评估。之后希望能够通过目前存在的某一问题（例如微博中出现两个DecorCaptionView的问题）来详细地记录一次符合上述标准的问题分析，解决过程，并以此为蓝本应对接下来的多窗口问题。在解决问题的过程中希望能够同时推进修改窗口结构和干涉应用操作的两种对于窗口结构方面问题的解决方案，并逐个分析优劣。上述规划均以解决问题为第一目标，并尽可能地遵守一般化解决原则。


以上便是对于openthos8多窗口部分开发的补充文档，希望能够对各位有帮助。
